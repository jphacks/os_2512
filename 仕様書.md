# プロジェクト仕様書：電気代節約システム（擬似環境版）

## 1. 概要
### 1.1. プロジェクト名
Oton-Zzz

### 1.2. 対象ユーザ
- オカン
### 1.3. 目的
オカンは
電気代を節約したいが、
オトンがテレビをつけたまま寝てしまうので困っており
仕方なくオトンを怒っているが
オトンが寝たら自動的にテレビを消してくれることに価値がある。

### 1.4. 背景
不要な電力消費といった課題を解決するために本システムを開発する。

## 2. システム構成
### 2.1. 構成図

### 2.2. コンポーネントの役割
|コンポーネント|役割|
|---|---|
|検出PC|カメラとマイクから情報を取得し、対象者の睡眠状態を判定。結果をM5Stick（Oton-Zzz）に送る。|
|M5Stick (Oton-Zzz)|検出PCからシリアル通信で指令を受け、赤外線信号を送信する。|
|リモコン(Panasonic製)|ボタンで赤外線信号を送信する。|
|M5Stick (テレビ)|M5Stick（Oton-Zzz）とリモコンからの赤外線信号を受信し、その情報をシリアル通信で受信用PCに伝える。（テレビの擬似役）|
|テレビPC|M5Stick（テレビ）から信号を受け取り、テレビが消えたことを演出する（テレビの擬似役）|
## 3. 機能要件
### 3.1. 睡眠検出機能

- 映像による検出

    - OpenCVで動きを、MediaPipeで顔のランドマーク（特にまぶた）を検出する。
    - 睡眠判定ロジック: まぶたが閉じている状態を検出し、その状態が5分間継続した場合に「睡眠状態」と判定する。

### 3.2. テレビ制御機能（擬似）
- 検出PCが睡眠と判定した場合、M5Stick（Oton-Zzz）にシリアル信号（例: "TV_OFF"）を送信する。
- リモコンは、ボタン入力で特定の赤外線信号-１を送信する。
- M5Stick（Oton-Zzz）は、信号を受信したら特定の赤外線信号-２を送信する。
- M5Stick（Oton-Zzz）は、特定の赤外線-2を受信したらテレビの点灯状態を保持する。
- M5Stick（テレビ）は、その赤外線信号-１,2を受信したら、受信用PCにシリアル信号（例："IR_RECEIVED"）を送信する。
- テレビPCは、シリアル信号を受信したら、テレビが消えたことを演出する。
- 演出に関しては、動画を切り替える方式を採用
- 赤外線信号-1はテレビが着いたり消えたりする信号
- 赤外線信号-2はテレビが消える信号

## 4．インターフェース定義(v0.2)
### 4.1. 検出PC ⇔ M5Stick (Oton-Zzz) 間インターフェース
- 物理層: USB
- 論理層: シリアル通信
- 通信パラメータ:
    - ボーレート: [要検討 (例: 115200)]
<!--     - その他: [要検討 (例: 8-N-1)] -->
- コマンド定義:

|コマンド|方向|説明|備考|
|--|--|--|--|
| "ALERT\n"| PC ↓ M5 | 睡眠中である可能性を検知した |  |
| "AWAKE\n"| PC ↓ M5 | 睡眠中ではない |  |
| "OFF\n"| PC ↓ M5 | テレビの電源をOFFにするよう指示する |  |

### 4.2. M5Stick (Oton-Zzz) ⇔ M5Stick (テレビ) 間インターフェース
- 物理層: 赤外線 (IR)
- プロトコル: NEC
- データ定義:

| 用途 | アドレス | コマンド |
| :--- | :--- | :--- |
| テレビ電源OFF | 0x555AF148688B | |

### 4.3. M5Stick (Oton-Zzz) ⇔ リモコン 間インターフェース
- 物理層: 赤外線 (IR)
- プロトコル: NEC
- データ定義:

| 用途 | アドレス | コマンド |
| :--- | :--- | :--- |
| テレビ状態保持 | [要検討 (例: 0x01)] | [要検討 (例: 0x02)] |

### 4.4. M5Stick (テレビ) ⇔ リモコン 間インターフェース

- 物理層: 赤外線 (IR)
- プロトコル: NEC
- データ定義:

| 用途 | アドレス | コマンド |
| :--- | :--- | :--- |
| テレビ電源ONOFF | [要検討 (例: 0x01)] | [要検討 (例: 0x02)] |

### 4.5. M5Stick (テレビ) ⇔ テレビPC 間インターフェース
- 物理層: USB
- 論理層: シリアル通信
- 通信パラメータ:
    - ボーレート: [要検討 (例: 115200)]
    - その他: [要検討 (例: 8-N-1)]
- メッセージ定義:

| メッセージ | 方向 | 説明 |
| :--- | :--- | :--- |
| "IR_RECEIVED\n" | M5 → PC | 赤外線信号を受信したことを通知する |

### 4.6. 検出PC 内部ソフトウェアインターフェース
- 映像処理モジュール
    - 関数: is_eyes_closed()
    - 戻り値: boolean (True or False)
    - 説明: 対象の目が閉じているかを判定し、結果を真偽値で返す。

- 睡眠判定モジュール

    - 関数: get_sleep_decision()
    - 入力: is_eyes_closed() の結果を継続的に監視する。
    - 戻り値: "AWAKE" または "SLEEPING" の文字列
    - 説明: 映像処理モジュールから True が5分間継続して返された場合に "SLEEPING" を返す。
## 5. 非機能要件
|項目	|要件|
|--|--|
|パフォーマンス|睡眠状態の検知完了後、10秒以内に受信用PCがスリープ状態に移行すること。|
|信頼性|[未定]|
|ユーザビリティ|[未定]|
## 6. 技術スタック
### 6.1. ハードウェア
- PC: 2台（Windows OS）
- マイクロコントローラ: M5StickC-Plus2 (2台)
- 赤外線送受信モジュール
- リモコン
- その他: Webカメラ, マイク

### 6.2. ソフトウェア
- 疑似テレビ層:
    - 言語: Python
    - ライブラリ:
        ```bash
        pyserial
        Opencv-python
        ```
- 検出層:
    - 言語: Python
    - ライブラリ:
        ```bash
        opencv-python
        mediapipe
        pyserial
        ```
- 送受信層
    - 言語: C++ (Arduino Framework)
    - ライブラリ:
        ```bash
        m5stack/M5StickCPlus2@^1.0.2
        # m5stack/M5Unified@^0.2.8
        crankyoldgit/IRremoteESP8266@^2.8.6
        ```
